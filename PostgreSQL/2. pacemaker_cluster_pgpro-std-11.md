# Инструкция по развертыванию отказоустойчевого кластера PostgreSQL из двух узлов

### Версию PostgreSQL в данном примере я выбрал PostgrePro standart 11 так как в дальнейшем планирую крутить на нем базы 1С, и версию OS AstraLinux SE 1.7, но данная настройка подходит и для других версий, отличаются только некоторые команды и пути.
<br>

### Предполагается что есть два заранее подготовленых хоста, которые видят друг друга по IP и имени, у них заранее настроен ntp сервер, установлены правильные дата и время, установлена локаль utf-8 ru-RU по умолчанию и en-US дополнительно и т.п. <br> В моем примере настроены следующие две ноды:<br>1) pg1 - 10.192.168.101/24<br>2) pg2 - 10.192.168.102/24<br><br>Для общего ip (master-ip) будет присвоен адрес 10.192.168.103/24<br>Для создания двухузлового кластера будет использовано ПО "Pacemaker"
<br><hr><br>

## 1. Установка Postgre и настройка репликации.
1.1. На всех нодах - устанавливаем postgrespro-std-11:
```bash
apt install wget -y
cd /tmp
wget https://repo.postgrespro.ru/std-11/keys/pgpro-repo-add.sh
sh pgpro-repo-add.sh
apt-get install postgrespro-std-11 -y
```
<br>

1.2. На всех нодах - cоздаем архив:

```bash
su - postgres
mkdir /var/lib/pgpro/std-11/pg_archive
```
<br>

1.3. На ноде №1 - редактируем postgresql.conf, меняем следующие параметры:
```sql
listen_addresses = '*'
wal_level = hot_standby
synchronous_commit = on
archive_mode = on
archive_command = 'cp %p /var/lib/pgpro/std-11/pg_archive/%f'
max_wal_senders = 5
wal_keep_segments = 32
hot_standby = on
restart_after_crash = off
wal_receiver_status_interval = 2
max_standby_streaming_delay = -1
max_standby_archive_delay = -1
hot_standby_feedback = on
lc_messages = 'en_US.UTF-8'
```

1.4. На ноде №1 - редактируем pg_hba.conf, добавляем следующие параметры:
```sql
host    all             all             all                     md5
host    replication     all             10.192.168.0/24         trust
```

1.5. На ноде №1 - перезапускаем службу postgresql и добавляем пользователя с правами админа в СУБД:

```bash
systemctl restart postgrespro-std-11.service
su - postgres
psql
```
```sql
CREATE USER sa WITH SUPERUSER PASSWORD '123';
```
1.6. На ноде №2 - копируем данные с ноды №1:
```bash
su - postgres
rm -rf /var/lib/pgpro/std-11/data/*
pg_basebackup -h 10.192.168.101 -U postgres -D /var/lib/pgpro/std-11/data -X stream -P
```

1.7. На ноде №2 - создаем файл "/var/lib/pgpro/std-11/data/recovery.conf" для подтверждения репликации и добавляем туда строки ниже:
```bash
su - postgres
nano /var/lib/pgpro/std-11/data/recovery.conf
``` 
```sql
standby_mode = 'on'
primary_conninfo = 'host=10.192.168.101 port=5432 user=postgres application_name=pg2'
restore_command = 'cp /var/lib/pgpro/std-11/pg_archive/%f %p'
recovery_target_timeline = 'latest'
```

1.8. На ноде №2 - перезапускаем службу postgresql:

```bash
systemctl restart postgrespro-std-11.service
```

1.9. На ноде №1 - проверяем репликацию:

```bash
su - postgres
psql -c "select client_addr,sync_state from pg_stat_replication;"
```
если вывод выглядит так, то репликация настроена успешно:
```sql
  client_addr   | sync_state
----------------+------------
 10.192.168.102 | async
(1 строка)
```
1.10. На всех нодах - отключаем службу postgresql и переходим к настройке:
```bash
systemctl stop postgrespro-std-11.service
```
<br>
<br>

## 2. Развертывание двухузлового кластера pacemaker
2.1. На всех нодах - Устанавливаем pacemaker и меняем пароль пользователя hacluster в дальнейшем будем использовать `<пароль>`:
```bash
apt install pacemaker pcs -y
passwd hacluster
```
